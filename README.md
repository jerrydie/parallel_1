# Оценка максимальной производительности системы

## Вариант задания и используемые технологии

Номер в таблице 24: вариант 8 - выбор операции и ее векторного исполнения за студентов. Сделанный выбор - целочисленное умножение, векторное целочисленное умножение.

Формулировка задачи:

- Написать программу, выполняющую в цикле заданную арифметическую операцию.
- Замерить время выполнения цикла. По результатам замера получить оценку производительности микропроцессора на заданной операции (в тактах процессора):
1. используя последовательность зависимых операций ("латентность"),
2. используя последовательность независимых операций("темп выдачи результатов").

Для корректности теста необходимо добиться того, чтобы после компиляции внутри цикла не было обращений в память, и все вычисления проходили на регистрах. Полезно убедиться в этом путём анализа ассемблерного листинга. Кроме того, необходимо следить, чтобы компилятор не устранил из кода нужные операции. При необходимости можно использовать для тестирования модификацию ассемблерного листинга, сгенерированного компилятором.

Данный отчетв включает: 

+ листинг программы на С++ (`src/main.cpp, src/format.hpp, src/format.cpp`);
+ листинг на ассемблере (`src/asm.asm`);
+ оценки производительности и их сравнение с теоретическими;
+ вывод по результатам задания.

Для векторизации вычислений использованы встроенные функции компилятора: 
- `_mm_set_epi32` для задания 128-битного вектора 32-битными целыми числами (SSE2),
- `_mm_mullo_epi32` для векторного перемножения 128-битных целочисленных векторов (SSE4.1),
- `_mm_extract_epi32` для получения из результирующего 128-битного вектора 32-юитных целых чисел (SSE4.1).

## Характеристики системы
```
cmd: lscpu output
```

|Характеристика                   |Значение
| ------------------------------- | -----------------------------------------
|Архитектура:                     |x86_64
|CPU op-mode(s):                  |32-bit, 64-bit
|Порядок байт:                    |Little Endian
|Address sizes:                   |39 bits physical, 48 bits virtual
|CPU(s):                          |1
|On-line CPU(s) list:             |0
|Потоков на ядро:                 |1
|Ядер на сокет:                   |1
|Сокетов:                         |1
|NUMA node(s):                    |1
|ID прроизводителя:               |GenuineIntel
|Семейство ЦПУ:                   |6
|Модель:                          |158
|Имя модели:                      |Intel(R) Core(TM) i7-7700HQ CPU @ 2.80GHz
|Степпинг:                        |9
|CPU МГц:                         |2807.996

## Компиляция и создание ассемблерного листинга из исполняемого файла

```
cmd: cd project_folder/src
cmd: g++ main.cpp format.cpp -g -O0 -march=native -o test.o
cmd: objdump -S test.o > asm.asm

```

## Фрагменты ассемблерного кода с замеряемыми циклами

### SIMPLE MULTIPLICATION
```
  for (;iterator < operations; iterator++)
    2691:	48 8b 85 68 ff ff ff 	mov    -0x98(%rbp),%rax
    2698:	48 3b 85 78 ff ff ff 	cmp    -0x88(%rbp),%rax
    269f:	73 1c                	jae    26bd <_ZL10simple_mulR9Mul_state+0xb2>
  	value1 *= value2; // зависимые операции
    26a1:	8b 85 48 ff ff ff    	mov    -0xb8(%rbp),%eax
    26a7:	0f af 85 4c ff ff ff 	imul   -0xb4(%rbp),%eax
    26ae:	89 85 48 ff ff ff    	mov    %eax,-0xb8(%rbp)
  for (;iterator < operations; iterator++)
    26b4:	48 ff 85 68 ff ff ff 	incq   -0x98(%rbp)
    26bb:	eb d4                	jmp    2691 <_ZL10simple_mulR9Mul_state+0x86>
```
Количество инструкций в одной операции - 8.
### SSE4.1 MULTIPLICATION

```
  for (;iterator < operations; iterator++)
    29de:	48 8b 85 28 ff ff ff 	mov    -0xd8(%rbp),%rax
    29e5:	48 3b 85 38 ff ff ff 	cmp    -0xc8(%rbp),%rax
    29ec:	73 38                	jae    2a26 <_ZL7sse_mulR9Mul_state+0x1a2>
    29ee:	c5 f9 6f 85 70 ff ff 	vmovdqa -0x90(%rbp),%xmm0
    29f5:	ff 
    29f6:	c5 f8 29 45 90       	vmovaps %xmm0,-0x70(%rbp)
    29fb:	c5 f9 6f 45 80       	vmovdqa -0x80(%rbp),%xmm0
    2a00:	c5 f8 29 45 a0       	vmovaps %xmm0,-0x60(%rbp)
/* Packed integer 32-bit multiplication with truncation of upper
   halves of results.  */
extern __inline __m128i __attribute__((__gnu_inline__, __always_inline__, __artificial__))
_mm_mullo_epi32 (__m128i __X, __m128i __Y)
{
  return (__m128i) ((__v4su)__X * (__v4su)__Y);
    2a05:	c5 f9 6f 4d 90       	vmovdqa -0x70(%rbp),%xmm1
    2a0a:	c5 f9 6f 45 a0       	vmovdqa -0x60(%rbp),%xmm0
    2a0f:	c4 e2 71 40 c0       	vpmulld %xmm0,%xmm1,%xmm0
    2a14:	90                   	nop
  	val1 = _mm_mullo_epi32(val1, val2); 
    2a15:	c5 f8 29 85 70 ff ff 	vmovaps %xmm0,-0x90(%rbp)
    2a1c:	ff 
  for (;iterator < operations; iterator++)
    2a1d:	48 ff 85 28 ff ff ff 	incq   -0xd8(%rbp)
    2a24:	eb b8                	jmp    29de <_ZL7sse_mulR9Mul_state+0x15a>
```
Количество инструкций в одной операции - 14.
## Результат измерений производитеьлности
```
cmd: ./test.o
```

### SIMPLE MULTIPLICATION
|       OPERATIONS        |          TIME           |   OPERATIONS / SECOND   |    PROCESSOR CLOCKS     |PROCESSOR CLOCKS / SECOND|           IPC           |           IPS           |    OPERATION RESULT     |
|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|
|          10000          |        0.000025         |    394166338.194718     |          70851          |    2792707922.743398    |        1.129130         |    3153330705.557745    |       1634275397        |
|         100000          |        0.000248         |    402732134.802500     |         697066          |    2807308782.782395    |        1.147668         |    3221857078.420001    |        -20761979        |
|         1000000         |        0.003308         |    302286951.934863     |         9286844         |    2807291765.854573    |        0.861434         |    2418295615.478906    |       2135439621        |
|        10000000         |        0.040682         |    245805990.591874     |        114230130        |    2807845026.008855    |        0.700341         |    1966447924.734992    |       -217368059        |
|        100000000        |        0.321433         |    311106800.553552     |        902573522        |    2807967606.937713    |        0.886354         |    2488854404.428419    |       -1867234299       |


### SSE4.1 MULTIPLICATION
|       OPERATIONS        |          TIME           |   OPERATIONS / SECOND   |    PROCESSOR CLOCKS     |PROCESSOR CLOCKS / SECOND|           IPC           |           IPS           |    OPERATION RESULT     |
|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|-------------------------|
|          10000          |        0.000028         |    363002758.820967     |          77105          |    2798932771.889066    |        1.815706         |    5082038623.493539    |       1538795669        |
|         100000          |        0.000185         |    541978982.055076     |         517921          |    2807022963.649470    |        2.703115         |    7587705748.771063    |        648736421        |
|         1000000         |        0.001508         |    663036761.410200     |         4233906         |    2807235322.355213    |        3.306639         |    9282514659.742796    |       -1768532411       |
|        10000000         |        0.015838         |    631394766.191993     |        44469013         |    2807750206.592368    |        3.148260         |    8839526726.687895    |       1749479045        |
|        100000000        |        0.178543         |    560088275.289033     |        501340296        |    2807948217.195333    |        2.792514         |    7841235854.046462    |       -477523707        |


### Пояснения и выводы
OPERATIONS / SECOND - пропускная способность конвейера, 

PROCESSOR CLOCKS / SECOND - тактовая частота процессора,

IPC - количество ассемблерных инструкций, выполненных за один такт,

IPS - количество ассемблерных инструкций, выполненных за одну секунду.
